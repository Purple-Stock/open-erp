<meta http-equiv="refresh" content="60">

<div class="container">
  <br><br><br>
  <h1>Pedidos Em andamento(Pagos)</h1>
  
  <a target="_blank" href="https://www.bling.com.br/OAuth2/views/authorization.php?response_type=code&client_id=<%= ENV['CLIENT_ID']%>&state=323eb862289daff1f11ee6c23edb4f6e&scopes=98308+98309+98310+98313+98314+98565+98619+101584+507943+575904+5990556+6631498+106168710+182224097+199272829+200802821+220621674+318257547+318257550+318257553+318257556+318257559+318257561+318257565+318257568+318257570+318257573+318257576+318257583+333936575+363921589+363921590+363921591+363921592+363921598+363921599+363953167+363953556+363953706+791588404+875116881+875116885+1649295804+1780272711+1869535257+5862218180+6239411327+6239420709+13645012976+13645012997+13645012998">Atualizar Token</a>

  <p>Última Atualização: <%= @last_update %></p>

  <p>Token Expira: <%= @expires_at %></p>

  <div class="row justify-content-center">

    <% @loja_ids.each do |loja_id| %>
    
      <% loja_name = @store_name[loja_id] %>
      
      <% orders = @orders.select { |o| o["loja"]["id"] == loja_id } %>
      
      <div class="col-md-4">

        <div class="card mb-4">
        
          <div class="card-body text-center <%= 'bg-danger' if loja_id == 204_061_683 && @mercado_envios_flex_counts >= 1 %>">
          
            <h5 class="card-title">
              <%= loja_name %>
            </h5>

            <p>
              Pedidos: <%= orders.count %>
            </p>

            <% if loja_id == 204_061_683 %>
            
              <p>
                Mercado Envios Flex: <%= @mercado_envios_flex_counts %>  
              </p>
            
            <% end %>
        
          </div>
        
        </div>
      
      </div>

    <% end %>

  </div>

</div>
<div class="container">
  <br><br><br>
  <h1>Pedidos Impressos</h1>


  <div class="row justify-content-center">

    <% @loja_ids.each do |loja_id| %>
    
      <% loja_name = @store_name[loja_id] %>
      
      <% printed_orders = @printed_orders.select { |o| o["loja"]["id"] == loja_id } %>
      
      <div class="col-md-4">

        <div class="card mb-4">
        
          <div class="card-body text-center <%= 'bg-danger' if loja_id == 204_061_683 && @mercado_envios_flex_counts >= 1 %>">
          
            <h5 class="card-title">
              <%= loja_name %>
            </h5>

            <p>
              Pedidos: <%= printed_orders.count %>
            </p>
        
          </div>
        
        </div>
      
      </div>

    <% end %>

  </div>

</div>

<div class="container">
  <br><br><br>
  <h1>Pedidos Pendentes</h1>

  <div class="row justify-content-center">
    <% @loja_ids.each do |loja_id| %>
      <% loja_name = @store_name[loja_id] %>
      <% pending_orders = @pending_orders.select { |o| o["loja"]["id"] == loja_id } %>

      <div class="col-md-4">
        <div class="card mb-4">
          <div class="card-body text-center <%= 'bg-danger' if loja_id == 204_061_683 && @mercado_envios_flex_counts >= 1 %>">
            <h5 class="card-title">
              <%= loja_name %>
            </h5>
            <p>
              Pedidos: <%= pending_orders.count %>
            </p>
            <% if pending_orders.any? %>
              <h6>Itens:</h6>
              <% codigo_to_bling_data = Hash.new { |h, k| h[k] = { quantidade_total: 0, links: [] } } %>
              <% pending_orders.each do |order| %>
                <% order_id = order["id"] %>
                <% bling_order_item = BlingOrderItem.find_by(bling_order_id: order_id) %>
                <% if bling_order_item %>
                  <% codigo = bling_order_item.codigo %>
                  <% quantidade = bling_order_item.quantidade %>
                  <% bling_order_id = bling_order_item.bling_order_id %>
                  <% codigo_to_bling_data[codigo][:quantidade_total] += quantidade %>
                  <% codigo_to_bling_data[codigo][:links] << { bling_id: bling_order_id, quantidade: quantidade } %>
                <% end %>
              <% end %>
              <ul>
                <% codigo_to_bling_data.each do |codigo, bling_data| %>
                  <li>
                    <strong>Código:</strong> <%= codigo %> | <strong>Quantidade Total:</strong> <%= bling_data[:quantidade_total] %>
                    <br>
                    <strong>Links:</strong>
                    <div class="accordion" id="accordion<%= codigo %>">
                      <div class="accordion-item">
                        <h2 class="accordion-header" id="heading<%= codigo %>">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= codigo %>" aria-expanded="false" aria-controls="collapse<%= codigo %>">
                            Clique para ver os links
                          </button>
                        </h2>
                        <div id="collapse<%= codigo %>" class="accordion-collapse collapse" aria-labelledby="heading<%= codigo %>" data-bs-parent="#accordion<%= codigo %>">
                          <div class="accordion-body">
                            <% bling_data[:links].each do |data| %>
                              <a href='https://www.bling.com.br/vendas.php#edit/<%= data[:bling_id] %>'>Pedido: <%= data[:bling_id] %> | Quantidade: <%= data[:quantidade] %></a><br>
                            <% end %>
                          </div>
                        </div>
                      </div>
                    </div>
                  </li>
                <% end %>
              </ul>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>









<div class="container">
  <br><br><br>
  <h1>Pedidos Verificados</h1>


  <div class="row justify-content-center">

    <% @loja_ids.each do |loja_id| %>
    
      <% loja_name = @store_name[loja_id] %>
      
      <% checked_orders = @checked_orders.select { |o| o["loja"]["id"] == loja_id } %>
      
      <div class="col-md-4">

        <div class="card mb-4">
        
          <div class="card-body text-center <%= 'bg-danger' if loja_id == 204_061_683 && @mercado_envios_flex_counts >= 1 %>">
          
            <h5 class="card-title">
              <%= loja_name %>
            </h5>

            <p>
              Pedidos: <%= checked_orders.count %>
            </p>
        
          </div>
        
        </div>
      
      </div>

    <% end %>

  </div>

</div>
