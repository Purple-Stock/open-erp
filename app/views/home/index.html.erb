<meta http-equiv="refresh" content="60">

<div class="container">
  <br><br><br>
  <h1>Pedidos Em andamento(Pagos)</h1>
  
  <a target="_blank" href="https://www.bling.com.br/OAuth2/views/authorization.php?response_type=code&client_id=<%= ENV['CLIENT_ID']%>&state=323eb862289daff1f11ee6c23edb4f6e&scopes=98308+98309+98310+98313+98314+98565+98619+101584+507943+575904+5990556+6631498+106168710+182224097+199272829+200802821+220621674+318257547+318257550+318257553+318257556+318257559+318257561+318257565+318257568+318257570+318257573+318257576+318257583+333936575+363921589+363921590+363921591+363921592+363921598+363921599+363953167+363953556+363953706+791588404+875116881+875116885+1649295804+1780272711+1869535257+5862218180+6239411327+6239420709+13645012976+13645012997+13645012998">Atualizar Token</a>

  <p>Última Atualização: <%= @last_update %></p>

  <p>Token Expira: <%= @expires_at %></p>

  <div class="row justify-content-center">

    <% @loja_ids.each do |loja_id| %>
    
      <% loja_name = @store_name[loja_id] %>
      
      <% orders = @orders.select { |o| o["loja"]["id"] == loja_id } %>
      
      <div class="col-md-4">

        <div class="card mb-4">
        
          <div class="card-body text-center <%= 'bg-danger' if loja_id == 204_061_683 && @mercado_envios_flex_counts >= 1 %>">
          
            <h5 class="card-title">
              <%= loja_name %>
            </h5>

            <p>
              Pedidos: <%= orders.count %>
            </p>

            <% if loja_id == 204_061_683 %>
            
              <p>
                Mercado Envios Flex: <%= @mercado_envios_flex_counts %>  
              </p>
            
            <% end %>
        
          </div>
        
        </div>
      
      </div>

    <% end %>

  </div>

</div>
<div class="container">
  <br><br><br>
  <h1>Pedidos Impressos</h1>


  <div class="row justify-content-center">

    <% @loja_ids.each do |loja_id| %>
    
      <% loja_name = @store_name[loja_id] %>
      
      <% printed_orders = @printed_orders.select { |o| o["loja"]["id"] == loja_id } %>
      
      <div class="col-md-4">

        <div class="card mb-4">
        
          <div class="card-body text-center <%= 'bg-danger' if loja_id == 204_061_683 && @mercado_envios_flex_counts >= 1 %>">
          
            <h5 class="card-title">
              <%= loja_name %>
            </h5>

            <p>
              Pedidos: <%= printed_orders.count %>
            </p>
        
          </div>
        
        </div>
      
      </div>

    <% end %>

  </div>

</div>

<div class="container">
  <br><br><br>
  <h1>Pedidos Pendentes</h1>

  <div class="row justify-content-center">
    <% @loja_ids.each do |loja_id| %>
      <% loja_name = @store_name[loja_id] %>
      <% pending_orders = @pending_orders.select { |o| o["loja"]["id"] == loja_id } %>

      <div class="col-md-4">
        <div class="card mb-4">
          <div class="card-body text-center <%= 'bg-danger' if loja_id == 204_061_683 && @mercado_envios_flex_counts >= 1 %>">
            <h5 class="card-title">
              <%= loja_name %>
            </h5>
            <p>
              Pedidos: <%= pending_orders.count %>
            </p>
            <% if pending_orders.any? %>
              <h6>Itens:</h6>
              <% codigo_to_bling_ids = Hash.new { |h, k| h[k] = [] } %>
              <% pending_orders.each do |order| %>
                <% order_id = order["id"] %>
                <% bling_order_item = BlingOrderItem.find_by(bling_order_id: order_id) %>
                <% if bling_order_item %>
                  <% codigo = bling_order_item.codigo %>
                  <% bling_order_id = bling_order_item.bling_order_id %>
                  <% codigo_to_bling_ids[codigo] << bling_order_id %>
                <% end %>
              <% end %>
              <% ordered_codigos = codigo_to_bling_ids.keys.sort_by { |codigo| -codigo_to_bling_ids[codigo].size } %>
              <ul>
                <% ordered_codigos.each do |codigo| %>
                  <% bling_ids = codigo_to_bling_ids[codigo] %>
                  <li>
                    <a href="#" data-toggle="collapse" data-target="#collapse<%= loja_id %>-<%= codigo %>">
                      <strong>Código:</strong> <%= codigo %> (Quantidade Total: <%= bling_ids.size %>)
                    </a>
                    <div id="collapse<%= loja_id %>-<%= codigo %>" class="collapse">
                      <strong>Links:</strong><br>
                      <% bling_ids.each do |bling_id| %>
                        <a href='https://www.bling.com.br/vendas.php#edit/<%= bling_id %>'>Pedido: <%= bling_id %></a>
                        <br>
                      <% end %>
                    </div>
                  </li>
                <% end %>
              </ul>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>






<div class="container">
  <br><br><br>
  <h1>Pedidos Verificados</h1>


  <div class="row justify-content-center">

    <% @loja_ids.each do |loja_id| %>
    
      <% loja_name = @store_name[loja_id] %>
      
      <% checked_orders = @checked_orders.select { |o| o["loja"]["id"] == loja_id } %>
      
      <div class="col-md-4">

        <div class="card mb-4">
        
          <div class="card-body text-center <%= 'bg-danger' if loja_id == 204_061_683 && @mercado_envios_flex_counts >= 1 %>">
          
            <h5 class="card-title">
              <%= loja_name %>
            </h5>

            <p>
              Pedidos: <%= checked_orders.count %>
            </p>
        
          </div>
        
        </div>
      
      </div>

    <% end %>

  </div>

</div>
