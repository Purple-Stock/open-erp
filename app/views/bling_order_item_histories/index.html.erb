<main class="main-content pl-0">
  <h1>Histórico de vendas dos últimos 15 dias</h1>
  <div>
    <canvas id="chartjs-bar"></canvas>
  </div>
</main>

<section class="mt-5 section bordered-section">
  <div class="row p-4">
    <h1>Pesquisar por data</h1>
    <%= form_tag(daily_revenue_bling_order_item_histories_path, method: :get) do %>
      <div class="input-group mb-5">
        <div class="col-sm">
          Data inicial
          <%= date_field('bling_order', 'initial_date', value: Date.today.strftime) %>
        </div>
        <div class="col-sm">
          Data final
          <%= date_field('bling_order', 'final_date', value: Date.today.strftime) %>
        </div>
        <div class="col-sm">
          <%= button_tag('Pesquisar...', class: 'btn btn-primary mb-3', id: 'daily-revenue-search',
                         data: { turbo_frame: 'daily-revenue-chart' }) %>
        </div>
      </div>
    <% end %>
  </div>
</section>

<section class="chart-container pl-0">
  <h1>Faturamento diário</h1>
  <div>
    <canvas id='chartjs-bar-monthly-revenue'></canvas>
  </div>
</section>

<script>
  $(document).ready(function (){
      function plotDailyRevenueChartBar(searchParams) {
          $.ajax({
              url: 'bling_order_item_histories/daily_revenue', data: searchParams, success: function (result) {
                  let data = result;
                  let cfg = {
                      type: 'bar',
                      options: {
                          maintainAspectRatio: false,
                          aspectRatio: 1
                      },
                      data: {
                          datasets: [{
                              label: 'Shein',
                              data: data,
                              parsing: {
                                  yAxisKey: 'shein'
                              }
                          }, {
                              label: 'Shopee',
                              data: data,
                              parsing: {
                                  yAxisKey: 'shopee'
                              }
                          }, {
                              label: 'Simple 7',
                              data: data,
                              parsing: {
                                  yAxisKey: 'simple_7'
                              }
                          },
                              {
                                  label: 'Mercado Livre',
                                  data: data,
                                  parsing: {
                                      yAxisKey: 'mercado_livre'
                                  }
                              }, {
                                  label: 'Total',
                                  data: data,
                                  parsing: {
                                      yAxisKey: 'total'
                                  }
                              }]
                      },
                  };

                  dailyRevenueChartBar = new Chart(document.getElementById('chartjs-bar-monthly-revenue'), cfg);
              }
          });
      }

      let dailyRevenueChartBar;
      let dailyRevenueSearchButton = $('daily-revenue-search');
      let initialDate = $('#bling_order_initial_date').val();
      let finalDate = $('#bling_order_final_date').val();
      let searchParams = { bling_order: { initial_date: initialDate, final_date: finalDate } }
      let options = {
          maintainAspectRatio: false,
          aspectRatio: 1,
          scales: {
              y: {
                  stacked: false,
                  grid: {
                      display: true,
                      color: "rgba(255,99,132,0.2)"
                  }
              },
              x: {
                  stacked: false,
                  grid: {
                      display: false
                  }
              }
          }
      };

      $.ajax({url: 'bling_order_item_histories/day_quantities', success: function(result){
              new Chart(
                  document.getElementById('chartjs-bar'),
                  {
                      type: 'bar',
                      options: options,
                      data: {
                          labels: result.map(row => row.day),
                          datasets: [
                              {
                                  label: 'Quantidade vendida nos últimos 15 dias',
                                  data: result.map(row => row.quantity)
                              }
                          ]
                      }
                  }
              )
      }})

      plotDailyRevenueChartBar(searchParams);
  });

</script>