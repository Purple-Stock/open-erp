<%- model_class = Stock -%>
<div class="section-header row-cols-2">
  <div class="page-header">
    <h1><%= t('stocks.two') %></h1>
  </div>
  <div class="d-flex justify-content-end">
    <%= button_to "Gerar Previsão de Venda", stocks_path(format: "csv"), class: "btn btn-success", method: :get %>
  </div>
</div>

<div class="form-group">
  <%= form_with(url: stocks_path, method: :get) do %>
    <%= select_tag "status", options_for_select([['Situação', ''], ['Ativo', 1], ['Inativo', 0]], @default_status_filter) %>
    <%= select_tag "balance_situation", options_for_select([['Saldo total', ''], ['Maior do que zero', 1], ['Igual a zero', 0], ['Menor do que zero', -1]], @default_situation_balance_filter) %>
    <%= text_field_tag "sku", @default_sku_filter, placeholder: "Filtrar por SKU" %>
    <%= submit_tag "Filtro", class: 'btn btn-primary' %>
  <% end %>
</div>

<div class="section-body">
  <div class="card">
    <div class="card-body">
      <%= turbo_frame_tag :stocks do %>
        <div class="table-responsive">
          <table id="stockTable" class="table table-striped">
            <thead>
            <tr>
              <th></th>
              <th><%= model_class.human_attribute_name(:id) %></th>
              <th><%= t('stocks.sku') %></th>
              <th>Physical Balance</th>
              <th>Virtual Balance</th>
              <th>Quantidade vendida dos últimos 30 dias</th>
              <th>Previsão para os próximos 30 dias</th>
              <th><%= t('stocks.product') %></th>
              <th><%= t '.actions', :default => t("helpers.actions") %></th>
            </tr>
            </thead>
            <tbody>
            <% @stocks_with_data.each_with_index do |(stock, data), index| %>
              <tr>
                <td>
                  <% if stock.balances.any? %>
                    <button class="btn btn-sm btn-outline-primary collapse-toggle" type="button" data-target="#collapse<%= index %>">
                      +
                    </button>
                  <% end %>
                </td>
                <td><%= link_to stock.id, stock_path(stock), data: { toggle: 'tooltip', turbo: false } %></td>
                <td><%= stock.product.sku %></td>
                <% sao_paulo_base = stock.balances.find { |b| b.deposit_id.to_s == '9023657532' } %>
                <td class="physical-balance">
                  <%= sao_paulo_base ? stock.balance(sao_paulo_base) : 'N/A' %>
                </td>
                <td class="virtual-balance">
                  <%= sao_paulo_base ? stock.virtual_balance(sao_paulo_base) : 'N/A' %>
                </td>
                <td><%= data[:total_sold] %></td>
                <td><%= data[:total_forecast] %></td>
                <td><%= stock.product.name %></td>
                <td>
                  <%= link_to icon('fas fa-eye'), stock, title: t('show'), class: 'btn btn-info', data: { toggle: 'tooltip', turbo: false } %>
                </td>
              </tr>
              <% if stock.balances.any? %>
                <tr class="collapse-row" id="collapse<%= index %>" style="display: none;">
                  <td colspan="9" class="p-0">
                    <table class="table table-sm table-bordered mb-0">
                      <thead>
                        <tr>
                          <th>Apply Discount</th>
                          <th>Warehouse</th>
                          <th>Physical Balance</th>
                          <th>Virtual Balance</th>
                          <th>Quantidade vendida dos últimos 30 dias</th>
                          <th>Previsão para os próximos 30 dias</th>
                        </tr>
                      </thead>
                      <tbody>
                        <% stock.balances.each do |balance| %>
                          <% warehouse_data = data[:warehouses][balance.deposit_id] %>
                          <tr>
                            <td>
                              <%= check_box_tag "discount_#{stock.id}_#{balance.deposit_id}", 1, stock.discounted_warehouse_sku_id == "#{balance.deposit_id}_#{stock.product.sku}", 
                                  class: 'discount-checkbox',
                                  data: { 
                                    stock_id: stock.id,
                                    warehouse_id: balance.deposit_id,
                                    sku: stock.product.sku
                                  } %>
                            </td>
                            <td><%= @warehouses[balance.deposit_id.to_s] || "Unknown (ID: #{balance.deposit_id})" %></td>
                            <td class="physical-balance"><%= stock.balance(balance) %></td>
                            <td class="virtual-balance"><%= stock.virtual_balance(balance) %></td>
                            <td><%= warehouse_data[:sold] %></td>
                            <td><%= warehouse_data[:forecast] %></td>
                          </tr>
                        <% end %>
                      </tbody>
                    </table>
                  </td>
                </tr>
              <% end %>
            <% end %>
            </tbody>
          </table>
          <%== pagy_bootstrap_nav(@pagy) %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<%= javascript_tag do %>
  document.addEventListener('turbo:load', function() {
    setupCollapseButtons();
    setupDiscountCheckboxes();
  });

  document.addEventListener('turbo:render', function() {
    setupCollapseButtons();
    setupDiscountCheckboxes();
  });

  function setupCollapseButtons() {
    const collapseButtons = document.querySelectorAll('.collapse-toggle');
    collapseButtons.forEach(button => {
      button.addEventListener('click', function() {
        const target = document.querySelector(this.dataset.target);
        if (target.style.display === 'none' || target.style.display === '') {
          target.style.display = 'table-row';
          this.textContent = '-';
        } else {
          target.style.display = 'none';
          this.textContent = '+';
        }
      });
    });
  }

  function setupDiscountCheckboxes() {
    const checkboxes = document.querySelectorAll('.discount-checkbox');
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const stockId = this.dataset.stockId;
        const warehouseId = this.dataset.warehouseId;
        const sku = this.dataset.sku;

        fetch(`/stocks/${stockId}/apply_discount`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          },
          body: JSON.stringify({ warehouse_id: warehouseId, sku: sku })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const row = this.closest('tr');
            const physicalBalanceCell = row.querySelector('.physical-balance');
            const virtualBalanceCell = row.querySelector('.virtual-balance');
            const forecastCell = row.querySelector('td:nth-child(6)');
            
            physicalBalanceCell.textContent = data.discounted_physical_balance;
            virtualBalanceCell.textContent = data.discounted_virtual_balance;
            forecastCell.textContent = data.new_forecast;

            // Update the main table row
            if (warehouseId === '9023657532') {
              const mainRow = row.closest('.collapse-row').previousElementSibling;
              const mainPhysicalBalanceCell = mainRow.querySelector('.physical-balance');
              const mainVirtualBalanceCell = mainRow.querySelector('.virtual-balance');
              const mainForecastCell = mainRow.querySelector('td:nth-child(7)');
              mainPhysicalBalanceCell.textContent = data.discounted_physical_balance;
              mainVirtualBalanceCell.textContent = data.discounted_virtual_balance;
              mainForecastCell.textContent = data.new_forecast;
            }
          }
        })
        .catch(error => console.error('Error:', error));
      });
    });
  }
<% end %>